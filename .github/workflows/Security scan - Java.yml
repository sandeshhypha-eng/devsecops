name: Security scan - Java (SonarCloud + ZAP)

# Purpose: This workflow builds the Java sample app, runs SonarCloud static analysis,
# starts the app on the runner and performs a dynamic scan using OWASP ZAP baseline.
# It uploads ZAP reports as workflow artifacts.
#
# High-level steps:
# 1) Checkout source
# 2) Set up Java
# 3) Build the app (Maven)
# 4) Run SonarCloud analysis (Maven Sonar plugin) - requires Sonar secrets (see CODE_EXPLANATION.md)
# 5) Start the built jar in the background on port 8080
# 6) Run OWASP ZAP baseline (in Docker) against the running app
# 7) Upload ZAP reports as artifacts
#
# SonarCloud notes (short):
# - Create a SonarCloud organization and project. Generate a token (User > My Account > Security).
# - In the GitHub repository Settings -> Secrets, add: SONAR_TOKEN, SONAR_PROJECT_KEY, SONAR_ORGANIZATION.
# - For Maven-based Java projects the `mvn sonar:sonar` invocation is used; the SONAR_TOKEN is passed as sonar.login.
# - See CODE_EXPLANATION.md for a detailed SonarCloud onboarding checklist and example `sonar-project.properties`.

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  java-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'

      - name: Build Java app
        run: |
          # Build the Java sample app using Maven. Skips tests for speed in demo runs.
          cd sample-java-app
          mvn -B -DskipTests package

      - name: SonarCloud analysis
        # Note: SONAR_TOKEN, SONAR_PROJECT_KEY and SONAR_ORGANIZATION must be set in repo secrets
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Run Sonar analysis with the Maven Sonar plugin.
          # The sonar.login property uses SONAR_TOKEN from the environment.
          cd sample-java-app
          mvn -B sonar:sonar \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${SONAR_TOKEN}

      - name: Start Java app
        run: |
          # Start the built jar in the background so ZAP can scan it. Logs are written to java-app.log.
          nohup java -jar sample-java-app/target/*jar > java-app.log 2>&1 &
          # Small wait to allow Spring Boot to boot up; increase if needed for your machine
          sleep 8

      - name: OWASP ZAP baseline scan (Java)
        run: |
          # Run the ZAP baseline scanner from the official Docker image.
          # We mount the workspace so the reports are output to the repository root.
          # host.docker.internal is added so the container can reach the services started on the runner.
          docker run --rm -v ${{ github.workspace }}:/zap/wrk/:rw --add-host=host.docker.internal:host-gateway owasp/zap2docker-stable \
            zap-baseline.py -t http://host.docker.internal:8080 -r zap-java-report.html -J zap-java-report.json || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: java-security-reports
          path: |
            zap-java-report.html
            zap-java-report.json
